<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.rawgit.com/etpinard/plotlyjs-finance/master/plotlyjs-finance.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
</head>
<body>

  <p>Candlestick Test</p>

  <div id="myDiv" style="width: 100%; height: 600px;"><!-- Plotly chart will be drawn inside this DIV --></div>

  <!-- <div id="tester" style="width:800px;height:400px;"></div> -->

  <select id="tickerSelector">
    <option value="Apple">Apple</option>
    <option value="British Petroleum">British Petroleum</option>
    <option value="Chevron">Chevron</option>
    <option value="Chipotle Mexican Grill">Chipotle Mexican Grill</option>
    <option value="Alphabet">Google</option>
    <option value="MacDonalds">MacDonalds</option>
    <option value="Starbucks">Starbucks</option>
    <option value="Yahoo">Yahoo</option>
    <option value="Allergan">Allergan</option>
  </select>


  <script>

  $(document).ready(function() {

    var test;

    $('select').on('change', function() {
      test = this.value;
      alert(test);

      $.get({
          url: '/api/ticker/' + test,
          success: function (data) {
                    console.log(data);
                    makeplot(data, data[0].name);
                    }
      });

    });


      $.get({
          url: '/api/ticker/<%= stockName %>',
          success: function (data) {
                    console.log(data);
                    makeplot(data, data[0].name);
                    }
      });

    });

    function makeplot(data, name) {
      var data_open = [], data_close = [], data_high = [], data_low = [], data_dates = [];

      for (var i=0; i<data.length; i++) {
         var data_obj = data[i];
         data_close.push(parseFloat(data_obj["close"]));
         data_high.push(parseFloat(data_obj["high"]));
         data_low.push(parseFloat(data_obj["low"]));
         data_open.push(parseFloat(data_obj["open"]));
         data_dates.push([data_obj["date"].split("-")].map(function(d) {
           return new Date(d[0], d[1]-1, d[2].substring(0,1));
         }))
      }
      makePlotly( data_open, data_close, data_high, data_low, data_dates, name);
      console.log(data_dates.length);

  };

  function makePlotly( data_open, data_close, data_high, data_low, data_dates, name){
    var dateArray = []

    data_dates.forEach(function(e){
      dateArray.push(e[0])
    })

    console.log(dateArray[1]);

    var fig = PlotlyFinance.createCandlestick({
      open: data_open,
      high: data_high,
      low: data_low,
      close: data_close,
      dates: dateArray
    });

    console.log(dateArray);
    console.log(data_close);

    fig.layout.title = name + " Prices between " + data_dates[data_dates.length-1].toString().substring(0,15) + " and " + data_dates[0].toString().substring(0,15);
    fig.layout.xaxis.title = 'Dates';
    fig.layout.yaxis.title = 'Price';

    Plotly.newPlot('myDiv', fig.data, fig.layout);
  };

  </script>
</body>
</html>
